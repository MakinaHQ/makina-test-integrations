# Makina Test Integrations

This repo is used to store the public TEST integrations used by the `makina-rs CLI`. Please note that if you are a private operator, configs can also live locally, or on another private GitHub repository. Refer to the Makina CLI documentation for more information on how to use local configs (`github:` and `local:`).

Integrations are made of "source files" (instructions, blueprints, calibers) which are then transpiled into rootfiles by the [transpiler](https://github.com/MakinaHQ/transpiler).

## Project Structure

```
blueprints/                                                 # contains boilerplate scripts for interacting with specific defi protocols
├── [protocol-name-1]/
│   ├── [action-name-1].yaml
│   ├── [action-name-2].yaml
│   └── ...
├── [protocol-name-2]/
└── ...

machines/
├── [machine-name-1]/
│   ├── config.toml
│   ├── [network-name-1]/
│   │   ├── caliber.yaml                                    # the input file for the transpiler
│   │   ├── instructions                                    # instructions written by humans
│   │   └── rootfiles                                       # transpiled* from instructions
│   │       ├── [timestamp]-[name-of-the-migration1].toml   # generated by the transpiler
│   │       ├── [timestamp]-[name-of-the-migration2].toml   # generated by the transpiler
│   │       └── ...
│   ├── [network-name-2]/
│   └── ...
└── ...
```

### Machines

Every machine gets its own toplevel directory (`machines`) for its rootfiles and instructions.

Network names (`[network-name-N]`) should match the chains defined in `config.toml`.

\* Transpiling of instructions is done by the [transpiler](https://github.com/MakinaHQ/transpiler).

The transpiler is run on the `[machine-name]/[network-name]/caliber.yaml` file and the output is stored in the `[machine-name]/[network-name]/rootfiles/[timestamp]-[name-of-the-migration].toml` file.

#### Instructions

It is in the instructions files that we feed the pool/caliber/machine-specific inputs for the blueprints.

#### Updating the rootfiles

When instructions, blueprints, or calibers are updated, the rootfiles must be regenerated. Add the new rootfiles to the corresponding `rootfiles` directory. Previous rootfiles are kept as references and remain necessary until the upgrade is applied on-chain. You can think of the rootfiles directory as a collection of “migration files.” The name of the rootfile should be: `[timestamp]-[name-of-the-migration].toml`. Where timestamps are in the format `YYYYMMDDHHMMSS` or `YYYYMMDD`.

## Formatting

1. [install dprint](https://dprint.dev/install/)
2. run `dprint fmt` in the project root
